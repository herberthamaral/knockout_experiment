<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Teste</title>
</head>
    <body>
        <form>
            <div>
                <div id="pessoa_form">
                    <p>Nome: <input data-bind="value: nome, valueUpdate: 'afterkeydown'" /></p>
                    <p>Sobrenome: <input data-bind="value: sobrenome, valueUpdate: 'afterkeydown'" /></p>
                    <p data-bind="html: nome_completo"></p>
                    <button data-bind="click: adicionar">Adicionar</button>
                </div>
                <div id="pessoa_list">
                    <ul data-bind="template: {name: 'listaPessoas', foreach: list}">
                    </ul>
                </div>
            </div>
        </form>
        <script src="jquery-1.7.1.min.js"></script> 
        <script src="jquery.tmpl.js"></script>
        <script type="text/javascript" src="knockout-2.0.0.js" ></script>

        <script type="text/html" id="listaPessoas">
            <li>
                <span data-bind="html: $data.nome_completo, click: $data.editar, visible: $data.view_mode"></span>
                <button data-bind="click: $data.remover, visible: $data.view_mode">Remover</button>
                <span data-bind="visible: $data.edit_mode">
                    <input data-bind="value: $data.pessoa.nome" type="text"/>
                    <input data-bind="value: $data.pessoa.sobrenome" type="text"/>
                    <button data-bind="click: $data.editar">Salvar</button>
                </span>
            </li>
        </script>

        <script type='text/javascript'>
            var PessoaRepository = ko.observableArray();

            var Pessoa = function(nome, sobrenome){
                this.nome = ko.observable(nome);
                this.sobrenome = ko.observable(sobrenome);
            }

            var PessoaItemListViewModel = function(pessoa){
                this.pessoa = pessoa;
                this.view_mode = ko.observable(true);
                this.edit_mode = ko.computed({
                    read:function(){
                        return !this.view_mode();
                    },
                    owner:this
                });

                this.editar = function(self){
                    console.warn(self);
                    self.view_mode(!self.view_mode());
                }

                this.remover = function(pessoa){
                    PessoaRepository.remove(pessoa);
                }

                this.nome_completo = ko.computed({
                    read:function(){
                        return this.pessoa.nome()+" "+this.pessoa.sobrenome();
                    },
                    owner:this
                });
            }

            var PessoaListViewModel = { 
                list : ko.observableArray()
            }

            var PessoaFormViewModel = function(){
                this.habilitado = ko.observable(true);
                this.nome = ko.observable('Herp');
                this.sobrenome = ko.observable('Derp');
                this.nome_completo = ko.computed({
                    read:function(){
                        return "Nome completo: "+this.nome()+" "+this.sobrenome();
                    },
                    owner:this
                });
                this.repository = PessoaRepository;

                this.adicionar = function(){
                    var pessoa = new Pessoa(this.nome(), this.sobrenome());
                    var pessoaView = new PessoaItemListViewModel(pessoa);
                    this.repository.push(pessoa);
                    PessoaListViewModel.list.push(pessoaView);
                }

            }
            var pessoaForm = new PessoaFormViewModel();
            ko.applyBindings(pessoaForm, document.getElementById('pessoa_form'));
            ko.applyBindings(PessoaListViewModel, document.getElementById('pessoa_list'));
        </script>
      
    </body>
</html>

